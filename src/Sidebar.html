<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CommSession</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: #374151;
      background: #ffffff;
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .logo {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: #4F46E5;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .status-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .status-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .status-badge.draft {
      background: #f3f4f6;
      color: #4b5563;
    }

    .status-badge.active {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.approved {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.paused {
      background: #fed7aa;
      color: #9a3412;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 13px;
      color: #6b7280;
    }

    .info-value {
      font-size: 13px;
      color: #111827;
      font-weight: 500;
    }

    .button {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 8px;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .button:active {
      transform: translateY(0);
    }

    .button-primary {
      background: #4F46E5;
      color: white;
    }

    .button-primary:hover {
      background: #4338ca;
    }

    .button-secondary {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .button-secondary:hover {
      background: #f9fafb;
    }

    .button-danger {
      background: #ffffff;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .button-danger:hover {
      background: #fef2f2;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #4F46E5;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }

    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 13px;
      line-height: 1.6;
    }

    .link {
      color: #4F46E5;
      text-decoration: none;
      font-weight: 500;
    }

    .link:hover {
      text-decoration: underline;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 20px 0;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .stat-item {
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
    }

    .stat-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #app {
      min-height: 400px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 12px;">Loading...</p>
    </div>
  </div>

  <script>
    // State
    let state = {
      status: null,
      loading: true,
      error: null
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadStatus();
    });

    // Load document status
    function loadStatus() {
      setState({ loading: true, error: null });

      google.script.run
        .withSuccessHandler(function(status) {
          setState({ status: status, loading: false });
          render();
        })
        .withFailureHandler(function(error) {
          setState({ error: error.message, loading: false });
          render();
        })
        .getDocumentStatus();
    }

    // Sync to CommSession
    function syncToCommSession() {
      setState({ loading: true, error: null });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('Document synced successfully!');
            loadStatus();
          } else {
            setState({ error: result.error, loading: false });
            render();
          }
        })
        .withFailureHandler(function(error) {
          setState({ error: error.message, loading: false });
          render();
        })
        .syncToCommSession();
    }

    // Open in CommSession
    function openInCommSession() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            window.open(result.url, '_blank');
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          showError(error.message);
        })
        .openInCommSession();
    }

    // Unlink document
    function unlinkDocument() {
      if (!confirm('Are you sure you want to unlink this document from CommSession?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('Document unlinked successfully');
            loadStatus();
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          showError(error.message);
        })
        .unlinkDocument();
    }

    // State management
    function setState(updates) {
      state = { ...state, ...updates };
    }

    function showError(message) {
      setState({ error: message });
      render();
    }

    function showSuccess(message) {
      setState({ error: null });
      render();
      // Could add a success message display here
    }

    // Render UI
    function render() {
      const app = document.getElementById('app');

      if (state.loading) {
        app.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 12px;">Loading...</p>
          </div>
        `;
        return;
      }

      if (state.error) {
        app.innerHTML = `
          <div class="error">${escapeHtml(state.error)}</div>
          ${renderContent()}
        `;
        return;
      }

      app.innerHTML = renderContent();
    }

    function renderContent() {
      const { status } = state;

      if (!status) {
        return renderEmptyState();
      }

      if (!status.linked) {
        return renderUnlinkedState(status);
      }

      return renderLinkedState(status);
    }

    function renderEmptyState() {
      return `
        <div class="header">
          <div class="logo">CS</div>
          <div class="title">CommSession</div>
        </div>
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ“„</div>
          <div class="empty-state-title">Unable to load document</div>
          <div class="empty-state-text">Please try refreshing the sidebar.</div>
        </div>
        <button class="button button-secondary" onclick="loadStatus()">Refresh</button>
      `;
    }

    function renderUnlinkedState(status) {
      return `
        <div class="header">
          <div class="logo">CS</div>
          <div class="title">CommSession</div>
        </div>

        <div class="empty-state">
          <div class="empty-state-icon">ðŸ”—</div>
          <div class="empty-state-title">Not linked to CommSession</div>
          <div class="empty-state-text">
            Sync this document to CommSession to start tracking approvals and governance.
          </div>
        </div>

        <div class="stats">
          <div class="stat-item">
            <div class="stat-value">${status.documentName ? status.documentName.length : 0}</div>
            <div class="stat-label">Characters</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">0</div>
            <div class="stat-label">Watchers</div>
          </div>
        </div>

        <button class="button button-primary" onclick="syncToCommSession()">
          Sync to CommSession
        </button>
      `;
    }

    function renderLinkedState(status) {
      const statusClass = (status.status && status.status.status) ? status.status.status.toLowerCase() : 'draft';
      const statusText = formatStatus((status.status && status.status.status) ? status.status.status : 'Draft');
      const lastSync = status.lastSync || 'Never';

      return `
        <div class="header">
          <div class="logo">CS</div>
          <div class="title">CommSession</div>
        </div>

        <div class="status-section">
          <div class="section-title">Status</div>
          <div class="status-card">
            <div class="status-badge ${statusClass}">${statusText}</div>
            <div class="info-row">
              <span class="info-label">Last Sync</span>
              <span class="info-value">${escapeHtml(formatDate(lastSync))}</span>
            </div>
            ${status.status && status.status.workflowStage ? `
              <div class="info-row">
                <span class="info-label">Workflow Stage</span>
                <span class="info-value">${escapeHtml(status.status.workflowStage)}</span>
              </div>
            ` : ''}
          </div>
        </div>

        <button class="button button-primary" onclick="syncToCommSession()">
          Sync Changes
        </button>

        <button class="button button-secondary" onclick="openInCommSession()">
          Open in CommSession â†’
        </button>

        <div class="divider"></div>

        <button class="button button-danger" onclick="unlinkDocument()">
          Unlink Document
        </button>
      `;
    }

    // Utility functions
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatStatus(status) {
      const statusMap = {
        'draft': 'Draft',
        'active': 'Under Review',
        'in_review': 'Under Review',
        'approved': 'Approved',
        'rejected': 'Rejected',
        'paused': 'Paused',
        'cancelled': 'Cancelled',
        'published': 'Published'
      };
      return statusMap[status.toLowerCase()] || status;
    }

    function formatDate(dateString) {
      if (!dateString || dateString === 'Never') return 'Never';

      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;

        return date.toLocaleDateString();
      } catch (e) {
        return dateString;
      }
    }
  </script>
</body>
</html>
