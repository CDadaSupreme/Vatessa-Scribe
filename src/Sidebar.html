<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      font-size: 13px;
      padding: 16px;
      margin: 0;
      color: #202124;
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    .logo {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    .title {
      font-size: 16px;
      font-weight: 500;
    }
    .status-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .status-label {
      font-size: 11px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-value {
      font-size: 14px;
      font-weight: 500;
      margin-top: 4px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      width: 100%;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #0B7FCB;
      color: white;
    }
    .btn-primary:hover {
      background: #0969A8;
    }
    .btn-secondary {
      background: white;
      color: #0B7FCB;
      border: 1px solid #dadce0;
    }
    .btn-secondary:hover {
      background: #f8f9fa;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .analysis-section {
      margin-top: 16px;
      border-top: 1px solid #dadce0;
      padding-top: 16px;
    }
    .score-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f1f3f4;
    }
    .score-label {
      color: #5f6368;
    }
    .score-value {
      font-weight: 500;
    }
    .score-good { color: #188038; }
    .score-warning { color: #f9ab00; }
    .score-bad { color: #d93025; }
    .suggestion {
      background: #fef7e0;
      border-left: 3px solid #f9ab00;
      padding: 8px 12px;
      margin: 8px 0;
      font-size: 12px;
      border-radius: 0 4px 4px 0;
    }
    .suggestion-original {
      text-decoration: line-through;
      color: #5f6368;
    }
    .suggestion-new {
      font-weight: 500;
      margin-top: 4px;
    }
    .suggestion-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .suggestion-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #5f6368;
    }
    .spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #0B7FCB;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background: #fce8e6;
      color: #c5221f;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .changes-banner {
      background: #fff3e0;
      border: 1px solid #ffcc80;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #e65100;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .approvers-list {
      margin: 8px 0;
    }
    .approver-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #f1f3f4;
      font-size: 12px;
    }
    .approver-item:last-child {
      border-bottom: none;
    }
    .type-selector {
      margin-bottom: 12px;
    }
    .type-selector label {
      font-size: 11px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
      margin-bottom: 6px;
    }
    .type-selector select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 13px;
      background: white;
      cursor: pointer;
    }
    .type-selector select:focus {
      outline: none;
      border-color: #0B7FCB;
    }
    .policy-note {
      background: #e8f0fe;
      border: 1px solid #c2d7f8;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      color: #1967d2;
    }

    /* AI Section Styles */
    .ai-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #dadce0;
    }
    .ai-section-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
    }
    .ai-status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }
    .ai-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9e9e9e;
    }
    .ai-status-dot.available {
      background: #4caf50;
    }
    .ai-status-dot.unavailable {
      background: #f44336;
    }
    .ai-button-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .ai-button-group .btn {
      flex: 1;
      margin-bottom: 0;
    }
    .btn-loading {
      display: none;
    }
    .ai-score-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .ai-score-card {
      text-align: center;
      padding: 12px 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .ai-score-value {
      font-size: 20px;
      font-weight: bold;
    }
    .ai-score-label {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      margin-top: 4px;
    }
    .ai-score-card.risk-low { background: #e8f5e9; }
    .ai-score-card.risk-medium { background: #fff3e0; }
    .ai-score-card.risk-high { background: #ffebee; }
    .ai-risk-low { color: #2e7d32; }
    .ai-risk-medium { color: #f57c00; }
    .ai-risk-high { color: #c62828; font-weight: bold; }
    .ai-results-section {
      margin-bottom: 12px;
    }
    .ai-results-section h4 {
      font-size: 12px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 8px 0;
    }
    .ai-results-section ul {
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
    }
    .ai-results-section li {
      margin-bottom: 6px;
    }
    .ai-summary {
      font-style: italic;
      color: #666;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .ai-error-container {
      text-align: center;
      padding: 16px;
      background: #fff3e0;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .ai-error-container.limit {
      background: #fce8e6;
    }
    .ai-error-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .ai-error-message {
      font-size: 12px;
      color: #5f6368;
      margin-bottom: 12px;
    }
    .ai-error-container a {
      color: #0B7FCB;
    }

    /* Polish Section Styles */
    .polish-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #dadce0;
    }
    .polish-section-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
    }
    .polish-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    .polish-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid #dadce0;
      background: white;
      color: #202124;
      transition: all 0.2s;
    }
    .polish-btn:hover {
      background: #f8f9fa;
      border-color: #0B7FCB;
      color: #0B7FCB;
    }
    .polish-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .polish-btn:disabled:hover {
      background: white;
      border-color: #dadce0;
      color: #202124;
    }
    .polish-btn.full-width {
      grid-column: 1 / -1;
    }
    .polish-btn-icon {
      font-size: 14px;
    }
    .rewrite-loading {
      text-align: center;
      padding: 16px;
      color: #5f6368;
    }
    .rewrite-preview {
      margin-bottom: 12px;
    }
    .rewrite-preview-label {
      font-size: 11px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .rewrite-preview-box {
      border: 1px solid #dadce0;
      border-radius: 4px;
      padding: 8px;
      font-size: 12px;
      max-height: 80px;
      overflow-y: auto;
      background: #f8f9fa;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .rewrite-preview-box.after {
      max-height: 120px;
      border-color: #0B7FCB;
      background: #e8f0fe;
    }
    .compliance-issues {
      background: #fff3e0;
      border: 1px solid #ffcc80;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 12px;
    }
    .compliance-issues-title {
      font-weight: 500;
      color: #e65100;
      margin-bottom: 6px;
    }
    .compliance-issues ul {
      margin: 0;
      padding-left: 16px;
      color: #bf360c;
    }
    .compliance-issues li {
      margin-bottom: 4px;
    }
    .rewrite-actions {
      display: flex;
      gap: 8px;
    }
    .rewrite-actions .btn {
      flex: 1;
      margin-bottom: 0;
      font-size: 12px;
      padding: 6px 10px;
    }
    .polish-tier-notice {
      text-align: center;
      padding: 16px;
      background: #fce8e6;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .polish-tier-notice a {
      color: #0B7FCB;
    }
  </style>
</head>
<body>
  <div class="header">
    <img class="logo" src="https://vatessa.com/vatessa-logo.png" alt="Vatessa" />
    <span class="title">Vatessa</span>
  </div>

  <div id="content">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
  </div>

  <script>
    let state = {
      connected: false,
      messageId: null,
      analysis: null,
      status: null,
      loading: true,
      error: null,
      messageType: 'communication',
      // AI-specific state
      aiAvailable: false,
      aiLoading: null, // 'analyze' | 'suggest' | null
      aiResult: null,
      aiError: null,
      aiLimitExceeded: false,
      // Polish-specific state
      rewriteLoading: false,
      rewriteResult: null,
      rewriteError: null,
      rewriteTierRequired: false,
      // Device auth state
      deviceAuth: null, // { deviceCode, userCode, verificationUrl, expiresIn }
      deviceAuthPolling: false,
      deviceAuthError: null,
      deviceAuthExpiry: null, // timestamp when code expires
    };

    var deviceAuthPollInterval = null;

    document.addEventListener('DOMContentLoaded', () => {
      checkStatus();
      checkAiAvailability();
    });

    // ===== AI Functions =====

    function checkAiAvailability() {
      google.script.run
        .withSuccessHandler(function(result) {
          state.aiAvailable = result && result.available === true;
          render();
        })
        .withFailureHandler(function() {
          state.aiAvailable = false;
          render();
        })
        .checkAiHealth();
    }

    function runAiAnalysis() {
      state.aiLoading = 'analyze';
      state.aiResult = null;
      state.aiError = null;
      state.aiLimitExceeded = false;
      render();

      google.script.run
        .withSuccessHandler(handleAiAnalysisResult)
        .withFailureHandler(handleAiError)
        .analyzeDocument();
    }

    function runAiSuggestions() {
      state.aiLoading = 'suggest';
      state.aiResult = null;
      state.aiError = null;
      state.aiLimitExceeded = false;
      render();

      google.script.run
        .withSuccessHandler(handleAiSuggestionsResult)
        .withFailureHandler(handleAiError)
        .getAiSuggestions();
    }

    function handleAiAnalysisResult(result) {
      state.aiLoading = null;

      if (!result.success) {
        if (result.error && result.error.code === 'limit_exceeded') {
          state.aiLimitExceeded = true;
        } else if (result.error && result.error.code === 'auth_expired') {
          state.aiError = 'Your session has expired. Please reconnect your Vatessa account.';
        } else {
          state.aiError = (result.error && result.error.message) || 'Unable to analyze document.';
        }
        render();
        // Focus on error for accessibility
        setTimeout(function() {
          var errorEl = document.getElementById('ai-error-container');
          if (errorEl) errorEl.focus();
        }, 100);
        return;
      }

      state.aiResult = {
        type: 'analyze',
        data: result.data,
        usage: result.usage,
      };
      render();
    }

    function handleAiSuggestionsResult(result) {
      state.aiLoading = null;

      if (!result.success) {
        if (result.error && result.error.code === 'limit_exceeded') {
          state.aiLimitExceeded = true;
        } else if (result.error && result.error.code === 'auth_expired') {
          state.aiError = 'Your session has expired. Please reconnect your Vatessa account.';
        } else {
          state.aiError = (result.error && result.error.message) || 'Unable to get suggestions.';
        }
        render();
        // Focus on error for accessibility
        setTimeout(function() {
          var errorEl = document.getElementById('ai-error-container');
          if (errorEl) errorEl.focus();
        }, 100);
        return;
      }

      state.aiResult = {
        type: 'suggest',
        data: result.data,
      };
      render();
    }

    function handleAiError(error) {
      state.aiLoading = null;
      state.aiError = 'Unable to connect to Vatessa. Please check your connection and try again.';
      render();
      // Focus on error for accessibility
      setTimeout(function() {
        var errorEl = document.getElementById('ai-error-container');
        if (errorEl) errorEl.focus();
      }, 100);
    }

    function retryAiAnalysis() {
      state.aiError = null;
      state.aiLimitExceeded = false;
      runAiAnalysis();
    }

    function renderAiSection() {
      var html = '<div class="ai-section">';
      html += '<div class="ai-section-title">AI Analysis</div>';

      // Status indicator
      var statusClass = state.aiAvailable ? 'available' : 'unavailable';
      var statusText = state.aiAvailable ? 'AI available' : 'AI temporarily unavailable';
      html += '<div class="ai-status-indicator" id="ai-status" role="status" aria-live="polite">' +
        '<span class="ai-status-dot ' + statusClass + '"></span>' +
        '<span class="ai-status-text">' + statusText + '</span></div>';

      // Button group
      var analyzeDisabled = !state.aiAvailable || state.aiLoading;
      var suggestDisabled = !state.aiAvailable || state.aiLoading;

      html += '<div class="ai-button-group" role="group" aria-label="AI analysis actions">';

      // Analyze button
      html += '<button class="btn btn-primary" onclick="runAiAnalysis()" ' +
        (analyzeDisabled ? 'disabled' : '') +
        ' aria-describedby="ai-status"' +
        (state.aiLoading === 'analyze' ? ' aria-busy="true"' : '') + '>' +
        '<span class="btn-text"' + (state.aiLoading === 'analyze' ? ' style="display:none"' : '') + '>Analyze</span>' +
        '<span class="btn-loading"' + (state.aiLoading === 'analyze' ? ' style="display:inline"' : '') + '>Analyzing...</span>' +
        '</button>';

      // Suggest button
      html += '<button class="btn btn-secondary" onclick="runAiSuggestions()" ' +
        (suggestDisabled ? 'disabled' : '') +
        ' aria-describedby="ai-status"' +
        (state.aiLoading === 'suggest' ? ' aria-busy="true"' : '') + '>' +
        '<span class="btn-text"' + (state.aiLoading === 'suggest' ? ' style="display:none"' : '') + '>Suggestions</span>' +
        '<span class="btn-loading"' + (state.aiLoading === 'suggest' ? ' style="display:inline"' : '') + '>Loading...</span>' +
        '</button>';

      html += '</div>';

      // Error container
      if (state.aiError) {
        html += '<div class="ai-error-container" id="ai-error-container" role="alert" aria-live="assertive" tabindex="-1">' +
          '<div class="ai-error-icon" aria-hidden="true">‚ö†Ô∏è</div>' +
          '<div class="ai-error-message">' + escapeHtml(state.aiError) + '</div>' +
          '<button class="btn btn-secondary" onclick="retryAiAnalysis()">Try Again</button></div>';
      }

      // Limit exceeded container
      if (state.aiLimitExceeded) {
        html += '<div class="ai-error-container limit" id="ai-error-container" role="alert" aria-live="assertive" tabindex="-1">' +
          '<div class="ai-error-icon" aria-hidden="true">üìä</div>' +
          '<div class="ai-error-message">Monthly AI limit reached. ' +
          '<a href="https://vatessa.com/upgrade" target="_blank">Upgrade for unlimited access</a></div></div>';
      }

      // Results
      if (state.aiResult && !state.aiError && !state.aiLimitExceeded) {
        html += '<div class="ai-results" role="region" aria-label="AI analysis results" aria-live="polite">';

        if (state.aiResult.type === 'analyze') {
          var data = state.aiResult.data;

          // Score grid
          html += '<div class="ai-score-grid">';
          html += '<div class="ai-score-card"><div class="ai-score-value">' +
            (data.toneScore || '-') + '</div><div class="ai-score-label">Tone</div></div>';
          html += '<div class="ai-score-card"><div class="ai-score-value">' +
            (data.clarityScore || '-') + '</div><div class="ai-score-label">Clarity</div></div>';

          var riskLevel = (data.riskLevel || 'low').toLowerCase();
          var riskClass = 'risk-' + riskLevel;
          html += '<div class="ai-score-card ' + riskClass + '"><div class="ai-score-value">' +
            escapeHtml((data.riskLevel || 'Low').toUpperCase()) + '</div><div class="ai-score-label">Risk</div></div>';
          html += '</div>';

          // Risks
          if (data.risks && data.risks.length > 0) {
            html += '<div class="ai-results-section"><h4>Identified Risks</h4><ul>';
            data.risks.forEach(function(r) {
              var severityClass = 'ai-risk-' + escapeHtml(r.severity || 'low');
              html += '<li class="' + severityClass + '">' + escapeHtml(r.description) + '</li>';
            });
            html += '</ul></div>';
          }

          // Suggestions from analyze (category, suggestion format)
          if (data.suggestions && data.suggestions.length > 0) {
            html += '<div class="ai-results-section"><h4>Suggestions</h4><ul>';
            data.suggestions.forEach(function(s) {
              html += '<li><strong>' + escapeHtml(s.category || 'General') + ':</strong> ' +
                escapeHtml(s.suggestion) + '</li>';
            });
            html += '</ul></div>';
          }

          // Summary
          if (data.summary) {
            html += '<div class="ai-summary">' + escapeHtml(data.summary) + '</div>';
          }

        } else if (state.aiResult.type === 'suggest') {
          // Suggestions from suggest endpoint (text, type format)
          var data = state.aiResult.data;
          if (data.suggestions && data.suggestions.length > 0) {
            html += '<div class="ai-results-section"><h4>AI Suggestions</h4><ul>';
            data.suggestions.forEach(function(s) {
              var typeLabel = escapeHtml(s.type || 'suggestion');
              html += '<li><strong>' + typeLabel + ':</strong> ' + escapeHtml(s.text) + '</li>';
            });
            html += '</ul></div>';
          } else {
            html += '<div class="ai-summary">No suggestions available for this content.</div>';
          }
        }

        // Refresh button
        html += '<button class="btn btn-secondary" onclick="runAiAnalysis()" style="font-size:12px;margin-top:8px;">Refresh Analysis</button>';

        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    // ===== Polish Functions =====

    function runRewrite(action) {
      state.rewriteLoading = true;
      state.rewriteResult = null;
      state.rewriteError = null;
      state.rewriteTierRequired = false;
      render();

      google.script.run
        .withSuccessHandler(handleRewriteResult)
        .withFailureHandler(handleRewriteError)
        .rewriteText(action);
    }

    function handleRewriteResult(result) {
      state.rewriteLoading = false;

      if (!result.success) {
        if (result.error && result.error.code === 'tier_required') {
          state.rewriteTierRequired = true;
        } else if (result.error && result.error.code === 'limit_exceeded') {
          state.aiLimitExceeded = true;
        } else if (result.error && result.error.code === 'auth_expired') {
          state.rewriteError = 'Your session has expired. Please reconnect your Vatessa account.';
        } else {
          state.rewriteError = (result.error && result.error.message) || 'Unable to rewrite text.';
        }
        render();
        return;
      }

      state.rewriteResult = {
        rewriteId: result.data.rewriteId,
        original: result.data.original,
        rewritten: result.data.rewritten,
        action: result.data.action,
        issues: result.data.issues || null,
        hasSelection: result.hasSelection,
      };
      render();
    }

    function handleRewriteError(error) {
      state.rewriteLoading = false;
      state.rewriteError = 'Unable to connect to Vatessa. Please check your connection and try again.';
      render();
    }

    function applyRewriteToDoc() {
      if (!state.rewriteResult) return;

      var rewriteId = state.rewriteResult.rewriteId;
      var rewrittenText = state.rewriteResult.rewritten;
      var replaceSelection = state.rewriteResult.hasSelection;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            state.rewriteResult = null;
            render();
          } else {
            state.rewriteError = result.error || 'Failed to apply rewrite.';
            render();
          }
        })
        .withFailureHandler(function() {
          state.rewriteError = 'Failed to apply rewrite to document.';
          render();
        })
        .applyRewrite(rewrittenText, replaceSelection);

      // Send feedback (fire-and-forget)
      google.script.run.sendRewriteFeedback(rewriteId, 'applied_replace');
    }

    function copyRewriteToClipboard() {
      if (!state.rewriteResult) return;

      var text = state.rewriteResult.rewritten;
      var rewriteId = state.rewriteResult.rewriteId;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          state.rewriteResult = null;
          render();
        }).catch(function() {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }

      // Send feedback (fire-and-forget)
      google.script.run.sendRewriteFeedback(rewriteId, 'copied');
    }

    function fallbackCopy(text) {
      var textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try { document.execCommand('copy'); } catch (e) {}
      document.body.removeChild(textarea);
      state.rewriteResult = null;
      render();
    }

    function dismissRewrite() {
      if (state.rewriteResult) {
        google.script.run.sendRewriteFeedback(state.rewriteResult.rewriteId, 'dismissed');
      }
      state.rewriteResult = null;
      state.rewriteError = null;
      state.rewriteTierRequired = false;
      render();
    }

    function renderPolishSection() {
      var html = '<div class="polish-section">';
      html += '<div class="polish-section-title">AI Polish</div>';

      // Tier required notice
      if (state.rewriteTierRequired) {
        html += '<div class="polish-tier-notice">' +
          '<div style="font-size:24px;margin-bottom:8px;">&#x1F512;</div>' +
          '<div style="font-size:12px;color:#5f6368;margin-bottom:8px;">AI Polish requires a Business tier plan.</div>' +
          '<a href="https://vatessa.com/upgrade" target="_blank">Upgrade Plan</a></div>';
        html += '</div>';
        return html;
      }

      // Mode buttons
      var disabled = !state.aiAvailable || state.rewriteLoading || state.rewriteResult;
      var disabledAttr = disabled ? ' disabled' : '';

      html += '<div class="polish-buttons">';
      html += '<button class="polish-btn" onclick="runRewrite(\'shorten\')"' + disabledAttr + '>' +
        '<span class="polish-btn-icon">&#9986;</span> Shorten</button>';
      html += '<button class="polish-btn" onclick="runRewrite(\'formal\')"' + disabledAttr + '>' +
        '<span class="polish-btn-icon">&#127891;</span> Formal</button>';
      html += '<button class="polish-btn" onclick="runRewrite(\'casual\')"' + disabledAttr + '>' +
        '<span class="polish-btn-icon">&#128172;</span> Casual</button>';
      html += '<button class="polish-btn" onclick="runRewrite(\'simplify\')"' + disabledAttr + '>' +
        '<span class="polish-btn-icon">&#10024;</span> Simplify</button>';
      html += '<button class="polish-btn full-width" onclick="runRewrite(\'compliance\')"' + disabledAttr + '>' +
        '<span class="polish-btn-icon">&#128737;</span> Compliance</button>';
      html += '</div>';

      // Loading
      if (state.rewriteLoading) {
        html += '<div class="rewrite-loading"><div class="spinner"></div><p>Rewriting...</p></div>';
      }

      // Error
      if (state.rewriteError) {
        html += '<div class="ai-error-container" role="alert">' +
          '<div class="ai-error-icon">&#9888;&#65039;</div>' +
          '<div class="ai-error-message">' + escapeHtml(state.rewriteError) + '</div>' +
          '<button class="btn btn-secondary" onclick="dismissRewrite()">Dismiss</button></div>';
      }

      // Limit exceeded (shared with AI section state)
      if (state.aiLimitExceeded && !state.rewriteResult) {
        // Already shown in AI section
      }

      // Result preview
      if (state.rewriteResult) {
        var r = state.rewriteResult;

        // Compliance issues
        if (r.issues && r.issues.length > 0) {
          html += '<div class="compliance-issues">' +
            '<div class="compliance-issues-title">&#9888;&#65039; Compliance Issues</div><ul>';
          for (var i = 0; i < r.issues.length; i++) {
            html += '<li>' + escapeHtml(r.issues[i]) + '</li>';
          }
          html += '</ul></div>';
        }

        // Before
        html += '<div class="rewrite-preview">' +
          '<div class="rewrite-preview-label">Before</div>' +
          '<div class="rewrite-preview-box">' + escapeHtml(r.original) + '</div></div>';

        // After
        html += '<div class="rewrite-preview">' +
          '<div class="rewrite-preview-label">After</div>' +
          '<div class="rewrite-preview-box after">' + escapeHtml(r.rewritten) + '</div></div>';

        // Actions
        html += '<div class="rewrite-actions">' +
          '<button class="btn btn-primary" onclick="applyRewriteToDoc()">Apply</button>' +
          '<button class="btn btn-secondary" onclick="copyRewriteToClipboard()">Copy</button>' +
          '<button class="btn btn-secondary" onclick="dismissRewrite()">Dismiss</button>' +
          '</div>';
      }

      html += '</div>';
      return html;
    }

    function checkStatus() {
      google.script.run
        .withSuccessHandler(handleStatusResponse)
        .withFailureHandler(handleError)
        .getConnectionStatus();
    }

    function handleStatusResponse(connectionStatus) {
      state.connected = connectionStatus.connected;
      state.messageId = connectionStatus.messageId;
      state.loading = false;
      if (state.connected) {
        loadDocumentStatus();
      } else {
        render();
      }
    }

    function loadDocumentStatus() {
      state.loading = true;
      render();
      google.script.run
        .withSuccessHandler(handleDocStatusResponse)
        .withFailureHandler(handleError)
        .getDocumentStatus();
    }

    function handleDocStatusResponse(docStatus) {
      state.status = docStatus;
      state.loading = false;
      if (docStatus.linked && docStatus.messageId) {
        state.messageId = docStatus.messageId;
      }
      // Restore saved message type if available
      if (docStatus.messageType) {
        state.messageType = docStatus.messageType;
      }
      render();
    }

    function loadAnalysis() {
      state.loading = true;
      render();
      google.script.run
        .withSuccessHandler(handleAnalysisResponse)
        .withFailureHandler(handleError)
        .analyzeDocument();
    }

    function handleAnalysisResponse(result) {
      if (result.success) {
        state.analysis = result.analysis;
      } else {
        state.error = result.error;
      }
      state.loading = false;
      render();
    }

    function handleError(error) {
      state.error = error.message || 'Something went wrong';
      state.loading = false;
      render();
    }

    function sendForApproval() {
      state.loading = true;
      render();
      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            state.messageId = result.messageId;
            state.error = null;
            loadDocumentStatus();
          } else {
            state.error = result.error;
            state.loading = false;
            render();
          }
        })
        .withFailureHandler(handleError)
        .sendForApproval(state.messageType);
    }

    function onMessageTypeChange(value) {
      state.messageType = value;
      render();
    }

    function syncChanges() {
      state.loading = true;
      render();
      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            state.error = null;
          } else {
            state.error = result.error;
          }
          loadDocumentStatus();
        })
        .withFailureHandler(handleError)
        .syncToVatessa();
    }

    function openInVatessa() {
      google.script.run
        .withSuccessHandler((result) => {
          if (result.success && result.url) {
            window.open(result.url, '_blank');
          }
        })
        .withFailureHandler(handleError)
        .openInVatessa();
    }

    function acceptSuggestion(index) {
      google.script.run
        .withSuccessHandler(() => loadAnalysis())
        .withFailureHandler(handleError)
        .acceptSuggestion(index);
    }

    function dismissSuggestion(index) {
      google.script.run
        .withSuccessHandler(() => loadAnalysis())
        .withFailureHandler(handleError)
        .dismissSuggestion(index);
    }

    function connect() {
      state.loading = true;
      state.deviceAuthError = null;
      render();

      google.script.run
        .withSuccessHandler(function(result) {
          state.loading = false;
          if (result.error) {
            state.deviceAuthError = result.error;
            render();
            return;
          }
          state.deviceAuth = result;
          state.deviceAuthExpiry = Date.now() + (result.expiresIn * 1000);
          state.deviceAuthPolling = true;
          render();
          startDeviceAuthPolling(result.deviceCode);
        })
        .withFailureHandler(function(err) {
          state.loading = false;
          state.deviceAuthError = err.message || 'Failed to start connection';
          render();
        })
        .initiateDeviceAuth();
    }

    function startDeviceAuthPolling(deviceCode) {
      // Clear any existing interval
      if (deviceAuthPollInterval) {
        clearInterval(deviceAuthPollInterval);
      }

      deviceAuthPollInterval = setInterval(function() {
        // Check if expired client-side
        if (state.deviceAuthExpiry && Date.now() > state.deviceAuthExpiry) {
          stopDeviceAuthPolling();
          state.deviceAuth = null;
          state.deviceAuthPolling = false;
          state.deviceAuthError = 'Code expired. Please try again.';
          render();
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.status === 'approved' && result.token) {
              stopDeviceAuthPolling();
              // Store the token and refresh
              google.script.run
                .withSuccessHandler(function() {
                  state.deviceAuth = null;
                  state.deviceAuthPolling = false;
                  state.deviceAuthError = null;
                  checkStatus();
                })
                .withFailureHandler(function() {
                  state.deviceAuthError = 'Failed to save connection. Please try again.';
                  state.deviceAuthPolling = false;
                  render();
                })
                .completeDeviceAuth(result.token);
            } else if (result.status === 'expired') {
              stopDeviceAuthPolling();
              state.deviceAuth = null;
              state.deviceAuthPolling = false;
              state.deviceAuthError = 'Code expired. Please try again.';
              render();
            }
            // If 'pending', do nothing ‚Äî keep polling
          })
          .withFailureHandler(function() {
            // Ignore transient polling errors, keep trying
          })
          .pollDeviceAuth(deviceCode);
      }, 3000);
    }

    function stopDeviceAuthPolling() {
      if (deviceAuthPollInterval) {
        clearInterval(deviceAuthPollInterval);
        deviceAuthPollInterval = null;
      }
    }

    function cancelDeviceAuth() {
      stopDeviceAuthPolling();
      state.deviceAuth = null;
      state.deviceAuthPolling = false;
      state.deviceAuthError = null;
      state.deviceAuthExpiry = null;
      render();
    }

    function getCountdownText() {
      if (!state.deviceAuthExpiry) return '';
      var remaining = Math.max(0, Math.floor((state.deviceAuthExpiry - Date.now()) / 1000));
      var mins = Math.floor(remaining / 60);
      var secs = remaining % 60;
      return mins + ':' + (secs < 10 ? '0' : '') + secs;
    }

    function disconnect() {
      google.script.run
        .withSuccessHandler(() => {
          state.connected = false;
          state.messageId = null;
          state.analysis = null;
          state.status = null;
          render();
        })
        .withFailureHandler(handleError)
        .disconnect();
    }

    function render() {
      const content = document.getElementById('content');

      if (state.loading) {
        content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
        return;
      }

      if (state.error) {
        content.innerHTML = '<div class="error">' + escapeHtml(state.error) + '</div>' +
          '<button class="btn btn-secondary" onclick="state.error=null;checkStatus();">Retry</button>';
        return;
      }

      if (!state.connected) {
        // Device auth flow active ‚Äî show code
        if (state.deviceAuth && state.deviceAuthPolling) {
          content.innerHTML = '<div class="status-card">' +
            '<div class="status-label">Connection Code</div>' +
            '<div style="font-family:monospace;font-size:28px;font-weight:bold;text-align:center;letter-spacing:4px;margin:12px 0;color:#0B7FCB;">' +
            escapeHtml(state.deviceAuth.userCode) + '</div>' +
            '<div style="text-align:center;margin-bottom:8px;">' +
            '<a href="' + escapeHtml(state.deviceAuth.verificationUrl) + '" target="_blank" ' +
            'style="color:#0B7FCB;font-size:13px;">Open app.vatessa.com/connect</a></div>' +
            '<div style="text-align:center;font-size:11px;color:#5f6368;">Code expires in <span id="countdown">' +
            getCountdownText() + '</span></div>' +
            '</div>' +
            '<div style="text-align:center;margin-bottom:12px;">' +
            '<div class="spinner" style="margin:8px auto;"></div>' +
            '<p style="font-size:12px;color:#5f6368;">Waiting for authorization...</p></div>' +
            '<button class="btn btn-secondary" onclick="cancelDeviceAuth()">Cancel</button>';

          // Update countdown every second
          if (!window._countdownInterval) {
            window._countdownInterval = setInterval(function() {
              var el = document.getElementById('countdown');
              if (el) { el.textContent = getCountdownText(); }
            }, 1000);
          }
          return;
        }

        // Clear countdown if not in device auth
        if (window._countdownInterval) {
          clearInterval(window._countdownInterval);
          window._countdownInterval = null;
        }

        var connectHtml = '<div class="status-card">' +
          '<div class="status-label">Status</div>' +
          '<div class="status-value">Not connected</div></div>' +
          '<p style="color:#5f6368;margin-bottom:16px;font-size:12px;">' +
          'Connect to Vatessa to analyze your document and manage approvals.</p>';

        if (state.deviceAuthError) {
          connectHtml += '<div class="error" style="margin-bottom:12px;">' +
            escapeHtml(state.deviceAuthError) + '</div>';
        }

        connectHtml += '<button class="btn btn-primary" onclick="connect()">Connect to Vatessa</button>';

        content.innerHTML = connectHtml;
        return;
      }

      // Clear countdown and polling when connected
      if (window._countdownInterval) {
        clearInterval(window._countdownInterval);
        window._countdownInterval = null;
      }

      let html = '';
      const status = state.status || {};
      const linked = status.linked || state.messageId;  // Use messageId as fallback
      const hasChanges = status.hasChanges;

      html += '<div class="status-card">' +
        '<div class="status-label">Document Status</div>' +
        '<div class="status-value">' + (linked ? 'Linked to Vatessa' : 'Not yet sent') + '</div></div>';

      if (hasChanges) {
        html += '<div class="changes-banner">Changes detected since last sync</div>';
      }

      // Message type selector (only show when creating new message)
      if (!state.messageId) {
        html += '<div class="type-selector">' +
          '<label>Message Type</label>' +
          '<select onchange="onMessageTypeChange(this.value)">' +
          '<option value="communication"' + (state.messageType === 'communication' ? ' selected' : '') + '>Communication</option>' +
          '<option value="policy"' + (state.messageType === 'policy' ? ' selected' : '') + '>Policy</option>' +
          '</select></div>';

        // Policy note
        if (state.messageType === 'policy') {
          html += '<div class="policy-note">Policy settings (acknowledgment, due date) can be configured in the Vatessa web app.</div>';
        }
      }

      html += '<button class="btn btn-primary" onclick="sendForApproval()">' +
        (state.messageId ? 'Update & Sync' : 'Send for Approval') + '</button>';

      if (state.messageId) {
        html += '<button class="btn btn-secondary" onclick="openInVatessa()">Open in Vatessa</button>';
        if (hasChanges) {
          html += '<button class="btn btn-secondary" onclick="syncChanges()">Sync Changes Only</button>';
        }
      }

      // Add AI section (replaces old Analyze Now button)
      html += renderAiSection();

      // Add Polish section
      html += renderPolishSection();

      if (linked && status.status) {
        const apiStatus = status.status;
        html += '<div class="analysis-section"><div class="status-label">Message Info</div>' +
          '<div class="score-row"><span class="score-label">Title</span>' +
          '<span class="score-value">' + escapeHtml(apiStatus.title || status.documentName) + '</span></div>' +
          '<div class="score-row"><span class="score-label">Status</span>' +
          '<span class="score-value">' + escapeHtml(apiStatus.status || 'Draft') + '</span></div>';
        if (status.lastSync) {
          html += '<div class="score-row"><span class="score-label">Last Sync</span>' +
            '<span class="score-value">' + formatTimeAgo(status.lastSync) + '</span></div>';
        }
        html += '</div>';

        if (apiStatus.approvers && apiStatus.approvers.length > 0) {
          html += '<div class="analysis-section"><div class="status-label">Approvers</div><div class="approvers-list">';
          apiStatus.approvers.slice(0, 3).forEach(function(a) {
            html += '<div class="approver-item"><span>' + escapeHtml(a.name || a.email) + '</span>' +
              '<span>' + getStatusEmoji(a.status) + '</span></div>';
          });
          if (apiStatus.approvers.length > 3) {
            html += '<div style="font-size:11px;color:#5f6368;padding-top:4px;">+' + (apiStatus.approvers.length - 3) + ' more</div>';
          }
          html += '</div></div>';
        }
      }

      // Note: Old analysis rendering removed - now using AI section above
      // Legacy state.analysis kept for backward compatibility but not rendered

      html += '<div style="margin-top:24px;padding-top:16px;border-top:1px solid #dadce0;">' +
        '<button class="btn btn-secondary" onclick="disconnect()" style="font-size:12px;color:#5f6368;">Disconnect</button></div>';

      content.innerHTML = html;
    }

    function renderAnalysis(analysis) {
      function scoreClass(score) {
        if (score >= 8) return 'score-good';
        if (score >= 5) return 'score-warning';
        return 'score-bad';
      }

      let html = '<div class="analysis-section"><div class="status-label">Analysis</div>' +
        '<div class="score-row"><span class="score-label">Overall</span>' +
        '<span class="score-value ' + scoreClass(analysis.overall_score) + '">' +
        (analysis.overall_score || 'N/A') + '/10</span></div>' +
        '<div class="score-row"><span class="score-label">Brevity</span>' +
        '<span class="score-value ' + scoreClass(analysis.brevity ? analysis.brevity.score : 0) + '">' +
        ((analysis.brevity && analysis.brevity.score) || 'N/A') + '/10</span></div>' +
        '<div class="score-row"><span class="score-label">Clarity</span>' +
        '<span class="score-value ' + scoreClass(analysis.clarity ? analysis.clarity.score : 0) + '">' +
        ((analysis.clarity && analysis.clarity.score) || 'N/A') + '/10</span></div>' +
        '<div class="score-row"><span class="score-label">Risk Level</span>' +
        '<span class="score-value">' + ((analysis.risks && analysis.risks.level) || 'None') + '</span></div></div>';

      let allSuggestions = [];
      if (analysis.brevity && analysis.brevity.suggestions) allSuggestions = allSuggestions.concat(analysis.brevity.suggestions);
      if (analysis.tone && analysis.tone.suggestions) allSuggestions = allSuggestions.concat(analysis.tone.suggestions);
      if (analysis.clarity && analysis.clarity.issues) allSuggestions = allSuggestions.concat(analysis.clarity.issues);

      if (allSuggestions.length > 0) {
        html += '<div class="analysis-section"><div class="status-label">Suggestions</div>';
        allSuggestions.slice(0, 5).forEach(function(s, i) {
          html += '<div class="suggestion">';
          if (s.original) html += '<div class="suggestion-original">' + escapeHtml(s.original) + '</div>';
          html += '<div class="suggestion-new">' + escapeHtml(s.suggestion || s.message || s) + '</div>' +
            '<div class="suggestion-actions">' +
            '<button class="suggestion-btn btn-primary" onclick="acceptSuggestion(' + i + ')">Apply</button>' +
            '<button class="suggestion-btn btn-secondary" onclick="dismissSuggestion(' + i + ')">Dismiss</button>' +
            '</div></div>';
        });
        html += '</div>';
      }

      if (analysis.triggered_rules && analysis.triggered_rules.length > 0) {
        html += '<div class="analysis-section"><div class="status-label">Approval Rules Triggered</div>';
        analysis.triggered_rules.forEach(function(rule) {
          html += '<div class="score-row"><span class="score-label">' + escapeHtml(rule) + '</span></div>';
        });
        html += '</div>';
      }

      return html;
    }

    function getStatusEmoji(status) {
      var emojis = { 'pending': '‚è≥', 'approved': '‚úÖ', 'changes_requested': 'üîÑ', 'rejected': '‚ùå' };
      return emojis[status] || '‚è≥';
    }

    function formatTimeAgo(timestamp) {
      if (!timestamp) return 'never';
      var now = new Date();
      var then = new Date(timestamp);
      var diffMs = now - then;
      var diffMins = Math.floor(diffMs / 1000 / 60);
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return diffMins + ' min ago';
      var diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return diffHours + 'h ago';
      var diffDays = Math.floor(diffHours / 24);
      return diffDays + 'd ago';
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
